# trackmypackage
Project developed to automate the task of checking the evolution of the status of a package delivery that uses the website
 - https://rastrearmeupedido.com.br/rastreamentoCpfCnpj.html

## Necessity
I had bought something online and had to constantly open this website to check if there were any updates on the shipment. I was a bit anxious awaiting for its arrival and for two days straight there were no updates at all. So I developed this little script to check for any updates automatically for me, working as a scheduled task.

## Checking the status
To check the status, I always had to open the website mentioned above an type in my information.

After the "login" part, it shows all the shipments made to you, with their latest status. For a more detailed view, to check the timeline of the delivery, there's a "details" button.

When you click it, it makes a request to the URL:
 - https://www.englobasistemas.com.br/gestao/api/PesquisasExternas/PesquisarPedidosCnpjCpf?0000000000000

The request had a URL encoded body:
 - codigo={id_of_the_delivery}&cpf_cnpj={id_of_the_recipient}&g-recaptcha-response={recaptcha_response}

As well as a Query String Paramenter in the URL:
 - Just a sequence of 13 numerals {0000000000000}

For the script to run, that information need to be filled in the file `requestparams_sample.cfg` (More detailed in the *Requirements* section)

The request response, is divided into two objects.
 - The first one contains general information of the delivery, like the *sender, recipient, status, info of the delivery company, etc...*
 - The second one is a list of all the occurrences, the [0], being the latest, like *En route to the destination, Transfered to the destined city, etc...*, as well as the date and time it occurred. If it was delivered, it displays information like the person who received, their id and their relationship with the person who ordered the package.

## Notification
For the notification, I created a VM on Google Cloud running 24x7 and a Cronjob to run the script every 10 minutes.

 - Each run, it makes a request and compares to the info saved on a file called `lastoccurrencedetails.txt`. If the latest occurrence has the same **id** as the one saved on the file, it means there were no updates on the status, so it just logs that information in the `trackmypackage.log` file.
 - The log is also used to identify if something unexpected happened during the request and caused an exception.
 - When the latest occurrence has an **id** different than the one saved in the file mantioned above, it means there's been an update, so it triggers the notification system that sends an e-mail with that information

To send an email, the file `email_sample.cfg` needs to be renamed to `email.cfg` and the info filled accordingly (More detailed in the *Requirements* section)

The email follows this structure:
 - **General Info**
    - If it was given as delivered, it will show the name, Id and relationship with the person who received it;
    - If it wasn't, it will just display some general info about the delivery, like the latest occurrence, the situation, sender and recipient. If it was delivered, this information will be displayed right after the one mentioned on the topic above;
 - **Delivery Timeline**
    - It will display a list of all the occurrences of the delivery until that moment, in descending order by date and time of the occurrence;
    - The information will be, more importantly, the date, description of the occurrence, and an observation if there is one.
 - **Shipping Company Info**
    - It will display the name of the company and possible ways to contact them if necessary.

## Requirements
Fill the following date in the file `requestparams_sample.cfg` and rename it to `requestparams.cfg`:
 - **url_param**=*Just a sequence of 13 numerals. In the tests, it began with `1709...`*
 - **codigo**=*The Id of the delivery*
 - **cpf_cnpj**=*Id of the recipient*
 - **g-recaptcha-response**=*Responses of the captcha*

To send an email, rename the file *email_sample.cfg* to *email.cfg* and fill the following data:
 - **mailto**=*who will receive the email*
 - **mailfrom**=*who will send the email*
 - **pwd**=*app password generated by the google account manager*

To generate the app password:
 - https://myaccount.google.com/apppasswords

## External Uses
 - Requests library (https://pypi.org/project/requests/)

## Sources
 - https://www.datacamp.com/tutorial/making-http-requests-in-python
 - https://docs.python.org/3/library/configparser.html
 - https://www.youtube.com/watch?v=N97q96BygUg
 - https://www.youtube.com/watch?v=LUyM7Nm1i9k